# Uniswap V3 Core å­¦ä¹ å¯¼å¼•

> ä¸€ä»½å¾ªåºæ¸è¿›çš„å¯¼å­¦æ–‡æ¡£ï¼Œå¸®åŠ©ä½ æ·±å…¥ç†è§£ Uniswap V3 çš„è®¾è®¡åŸåˆ™å’Œç²¾å¦™ä¹‹å¤„

## ğŸ“š ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ ¸å¿ƒåˆ›æ–°](#æ ¸å¿ƒåˆ›æ–°)
3. [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
4. [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
5. [åˆçº¦è¯¦è§£](#åˆçº¦è¯¦è§£)
6. [æ•°å­¦åº“ç²¾æ](#æ•°å­¦åº“ç²¾æ)
7. [è®¾è®¡æ¨¡å¼ä¸ä¼˜åŒ–](#è®¾è®¡æ¨¡å¼ä¸ä¼˜åŒ–)
8. [å­¦ä¹ è·¯å¾„å»ºè®®](#å­¦ä¹ è·¯å¾„å»ºè®®)

---

## é¡¹ç›®æ¦‚è¿°

Uniswap V3 Core æ˜¯å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ Uniswap çš„ç¬¬ä¸‰ä¸ªç‰ˆæœ¬çš„æ ¸å¿ƒåˆçº¦å®ç°ã€‚ç›¸æ¯” V2ï¼ŒV3 å¼•å…¥äº†**é›†ä¸­æµåŠ¨æ€§ï¼ˆConcentrated Liquidityï¼‰**çš„æ¦‚å¿µï¼Œå…è®¸æµåŠ¨æ€§æä¾›è€…ï¼ˆLPï¼‰åœ¨ç‰¹å®šçš„ä»·æ ¼åŒºé—´å†…æä¾›æµåŠ¨æ€§ï¼Œä»è€Œå¤§å¹…æé«˜èµ„æœ¬æ•ˆç‡ã€‚

### V3 vs V2 çš„å…³é”®åŒºåˆ«

| ç‰¹æ€§ | V2 | V3 |
|------|----|----|
| æµåŠ¨æ€§åˆ†å¸ƒ | å…¨ä»·æ ¼èŒƒå›´ | å¯è‡ªå®šä¹‰ä»·æ ¼åŒºé—´ |
| èµ„æœ¬æ•ˆç‡ | ä½ï¼ˆå¤§é‡èµ„é‡‘é—²ç½®ï¼‰ | é«˜ï¼ˆæœ€é«˜å¯è¾¾4000å€ï¼‰ |
| ä»·æ ¼è¡¨ç¤º | ç›´æ¥å­˜å‚¨ | ä½¿ç”¨ Tick å’Œ sqrtPrice |
| æ‰‹ç»­è´¹ç­‰çº§ | å›ºå®š 0.3% | 0.05%, 0.3%, 1% å¯é€‰ |
| é¢„è¨€æœº | ç®€å•æ—¶é—´åŠ æƒå¹³å‡ | æ›´å¼ºå¤§çš„ TWAP é¢„è¨€æœº |

---

## æ ¸å¿ƒåˆ›æ–°

### 1. é›†ä¸­æµåŠ¨æ€§ï¼ˆConcentrated Liquidityï¼‰

**æ ¸å¿ƒæ€æƒ³**ï¼šLP ä¸å†éœ€è¦åœ¨å…¨ä»·æ ¼èŒƒå›´å†…æä¾›æµåŠ¨æ€§ï¼Œè€Œæ˜¯å¯ä»¥é€‰æ‹©ä¸€ä¸ªä»·æ ¼åŒºé—´ `[tickLower, tickUpper]`ï¼Œåªåœ¨è¿™ä¸ªåŒºé—´å†…æä¾›æµåŠ¨æ€§ã€‚

**ä¼˜åŠ¿**ï¼š
- **èµ„æœ¬æ•ˆç‡æå‡**ï¼šç›¸åŒæ•°é‡çš„æµåŠ¨æ€§å¯ä»¥äº§ç”Ÿæ›´å¤šçš„äº¤æ˜“æ‰‹ç»­è´¹
- **çµæ´»ç­–ç•¥**ï¼šLP å¯ä»¥æ ¹æ®å¸‚åœºé¢„æœŸé€‰æ‹©ä¸åŒçš„ä»·æ ¼åŒºé—´
- **é£é™©æ§åˆ¶**ï¼šLP å¯ä»¥é¿å…åœ¨ä¸éœ€è¦çš„ä»·æ ¼åŒºé—´æ‰¿æ‹…é£é™©

### 2. Tick ç³»ç»Ÿ

V3 å°†è¿ç»­çš„ä»·æ ¼ç©ºé—´ç¦»æ•£åŒ–ä¸º **Tick**ã€‚æ¯ä¸ª Tick ä»£è¡¨ä¸€ä¸ªä»·æ ¼ç‚¹ï¼š
- ä»·æ ¼å…¬å¼ï¼š`price = 1.0001^tick`
- Tick é—´è·ï¼ˆtickSpacingï¼‰ï¼šæ ¹æ®æ‰‹ç»­è´¹ç­‰çº§ä¸åŒï¼Œåªæœ‰ç‰¹å®šé—´éš”çš„ Tick å¯ä»¥è¢«ä½¿ç”¨
  - 0.05% æ‰‹ç»­è´¹ï¼štickSpacing = 10
  - 0.3% æ‰‹ç»­è´¹ï¼štickSpacing = 60
  - 1% æ‰‹ç»­è´¹ï¼štickSpacing = 200

### 3. ä»·æ ¼è¡¨ç¤ºï¼šsqrtPriceX96

V3 ä½¿ç”¨ `sqrt(price) * 2^96` çš„æ ¼å¼å­˜å‚¨ä»·æ ¼ï¼Œè¿™æ˜¯ä¸€ä¸ª Q64.96 å®šç‚¹æ•°ï¼š
- **ä¸ºä»€ä¹ˆç”¨å¹³æ–¹æ ¹**ï¼šç®€åŒ–æµåŠ¨æ€§è®¡ç®—ï¼Œé¿å…å¼€æ–¹è¿ç®—
- **ä¸ºä»€ä¹ˆä¹˜ä»¥ 2^96**ï¼šä½¿ç”¨å®šç‚¹æ•°æé«˜ç²¾åº¦ï¼ŒåŒæ—¶é¿å…æµ®ç‚¹æ•°
- **X96 çš„å«ä¹‰**ï¼šè¡¨ç¤ºå°æ•°ç‚¹åæœ‰ 96 ä½

---

## é¡¹ç›®ç»“æ„

```
contracts/
â”œâ”€â”€ UniswapV3Factory.sol          # å·¥å‚åˆçº¦ï¼šåˆ›å»ºå’Œç®¡ç†æ± å­
â”œâ”€â”€ UniswapV3Pool.sol             # æ ¸å¿ƒæ± åˆçº¦ï¼šå®ç°æ‰€æœ‰äº¤æ˜“é€»è¾‘
â”œâ”€â”€ UniswapV3PoolDeployer.sol     # æ± éƒ¨ç½²å™¨ï¼šä½¿ç”¨ CREATE2 éƒ¨ç½²æ± å­
â”œâ”€â”€ NoDelegateCall.sol            # é˜²æ­¢å§”æ‰˜è°ƒç”¨æ”»å‡»
â”‚
â”œâ”€â”€ interfaces/                   # æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ IUniswapV3Factory.sol
â”‚   â”œâ”€â”€ IUniswapV3Pool.sol
â”‚   â”œâ”€â”€ callback/                 # å›è°ƒæ¥å£
â”‚   â”‚   â”œâ”€â”€ IUniswapV3MintCallback.sol
â”‚   â”‚   â”œâ”€â”€ IUniswapV3SwapCallback.sol
â”‚   â”‚   â””â”€â”€ IUniswapV3FlashCallback.sol
â”‚   â””â”€â”€ pool/                     # æ± æ¥å£æ‹†åˆ†
â”‚       â”œâ”€â”€ IUniswapV3PoolActions.sol
â”‚       â”œâ”€â”€ IUniswapV3PoolState.sol
â”‚       â””â”€â”€ ...
â”‚
â””â”€â”€ libraries/                    # æ ¸å¿ƒæ•°å­¦åº“
    â”œâ”€â”€ TickMath.sol              # Tick ä¸ä»·æ ¼è½¬æ¢
    â”œâ”€â”€ SqrtPriceMath.sol         # åŸºäº sqrtPrice çš„è®¡ç®—
    â”œâ”€â”€ SwapMath.sol              # äº¤æ¢è®¡ç®—
    â”œâ”€â”€ Tick.sol                  # Tick ç®¡ç†
    â”œâ”€â”€ Position.sol              # ä»“ä½ç®¡ç†
    â”œâ”€â”€ Oracle.sol                # é¢„è¨€æœº
    â”œâ”€â”€ TickBitmap.sol            # Tick ä½å›¾ä¼˜åŒ–
    â”œâ”€â”€ LiquidityMath.sol         # æµåŠ¨æ€§è®¡ç®—
    â””â”€â”€ FullMath.sol              # é«˜ç²¾åº¦æ•°å­¦è¿ç®—
```

---

## æ ¸å¿ƒæ¦‚å¿µ

### 1. Tick å’Œä»·æ ¼

**Tick** æ˜¯ä»·æ ¼ç©ºé—´çš„ç¦»æ•£åŒ–è¡¨ç¤ºï¼š

```solidity
// ä»·æ ¼ = 1.0001^tick
// sqrtPrice = sqrt(1.0001^tick) * 2^96
```

**å…³é”®å¸¸é‡**ï¼š
- `MIN_TICK = -887272`ï¼šæœ€å° Tick
- `MAX_TICK = 887272`ï¼šæœ€å¤§ Tick
- æ¯ä¸ª Tick ä»£è¡¨ 0.01% çš„ä»·æ ¼å˜åŒ–

**å­¦ä¹ è¦ç‚¹**ï¼š
- é˜…è¯» `libraries/TickMath.sol`ï¼Œç†è§£ä»·æ ¼ä¸ Tick çš„è½¬æ¢
- æ³¨æ„ `getSqrtRatioAtTick` å’Œ `getTickAtSqrtRatio` çš„å®ç°

### 2. æµåŠ¨æ€§ï¼ˆLiquidityï¼‰

åœ¨ V3 ä¸­ï¼ŒæµåŠ¨æ€§æ˜¯ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œè¡¨ç¤ºåœ¨ä»·æ ¼åŒºé—´å†…å¯ä»¥äº¤æ˜“çš„èµ„äº§æ•°é‡ã€‚

**æµåŠ¨æ€§å…¬å¼**ï¼š
- å¯¹äºä»·æ ¼åŒºé—´ `[Pa, Pb]`ï¼ŒæµåŠ¨æ€§ L æ»¡è¶³ï¼š
  - `L = amount0 * sqrt(Pa * Pb) / (sqrt(Pb) - sqrt(Pa))`
  - `L = amount1 / (sqrt(Pb) - sqrt(Pa))`

**å…³é”®ç‚¹**ï¼š
- æµåŠ¨æ€§æ˜¯å…¨å±€çš„ï¼Œä½†æ¯ä¸ªä»“ä½åªè´¡çŒ®éƒ¨åˆ†æµåŠ¨æ€§
- å½“ä»·æ ¼ç§»åŠ¨æ—¶ï¼Œåªæœ‰"æ¿€æ´»"çš„æµåŠ¨æ€§å‚ä¸äº¤æ˜“

### 3. ä»“ä½ï¼ˆPositionï¼‰

æ¯ä¸ªä»“ä½ç”±ä»¥ä¸‹ä¿¡æ¯å”¯ä¸€æ ‡è¯†ï¼š
- `owner`ï¼šä»“ä½æ‰€æœ‰è€…
- `tickLower`ï¼šä¸‹è¾¹ç•Œ Tick
- `tickUpper`ï¼šä¸Šè¾¹ç•Œ Tick

**ä»“ä½çŠ¶æ€**ï¼š
- `liquidity`ï¼šè¯¥ä»“ä½çš„æµåŠ¨æ€§æ•°é‡
- `feeGrowthInside0LastX128`ï¼šä¸Šæ¬¡æ›´æ–°æ—¶çš„ token0 æ‰‹ç»­è´¹å¢é•¿ç‡
- `feeGrowthInside1LastX128`ï¼šä¸Šæ¬¡æ›´æ–°æ—¶çš„ token1 æ‰‹ç»­è´¹å¢é•¿ç‡
- `tokensOwed0/1`ï¼šç´¯è®¡æœªæå–çš„æ‰‹ç»­è´¹

### 4. æ‰‹ç»­è´¹è®¡ç®—

V3 ä½¿ç”¨**å…¨å±€æ‰‹ç»­è´¹å¢é•¿ç‡**æ¥è·Ÿè¸ªæ‰‹ç»­è´¹ï¼š

```solidity
// å…¨å±€æ‰‹ç»­è´¹å¢é•¿ç‡ï¼ˆæ¯å•ä½æµåŠ¨æ€§ï¼‰
feeGrowthGlobal0X128 += (feeAmount0 * 2^128) / totalLiquidity

// ä»“ä½åº”å¾—æ‰‹ç»­è´¹ = (feeGrowthInside - feeGrowthInsideLast) * positionLiquidity / 2^128
```

**ç²¾å¦™ä¹‹å¤„**ï¼š
- ä¸éœ€è¦ä¸ºæ¯ä¸ªä»“ä½å•ç‹¬è®¡ç®—æ‰‹ç»­è´¹
- åªåœ¨ mint/burn/collect æ—¶æ›´æ–°ï¼ŒèŠ‚çœ gas
- ä½¿ç”¨ç›¸å¯¹å€¼è€Œéç»å¯¹å€¼ï¼Œé¿å…æº¢å‡º

---

## åˆçº¦è¯¦è§£

### 1. UniswapV3Factory.sol

**èŒè´£**ï¼šåˆ›å»ºå’Œç®¡ç†äº¤æ˜“æ± 

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- `createPool(tokenA, tokenB, fee)`ï¼šåˆ›å»ºæ–°çš„äº¤æ˜“æ± 
- `enableFeeAmount(fee, tickSpacing)`ï¼šå¯ç”¨æ–°çš„æ‰‹ç»­è´¹ç­‰çº§
- `setOwner(owner)`ï¼šè®¾ç½®å·¥å‚æ‰€æœ‰è€…

**è®¾è®¡äº®ç‚¹**ï¼š
- ä½¿ç”¨ `UniswapV3PoolDeployer` é€šè¿‡ CREATE2 éƒ¨ç½²æ± å­ï¼Œç¡®ä¿åœ°å€ç¡®å®šæ€§
- ç»´æŠ¤ `getPool[token0][token1][fee]` æ˜ å°„ï¼Œå¿«é€ŸæŸ¥æ‰¾æ± å­
- æ”¯æŒä¸‰ç§æ ‡å‡†æ‰‹ç»­è´¹ï¼š0.05%, 0.3%, 1%

**å­¦ä¹ å»ºè®®**ï¼š
1. ç†è§£ CREATE2 çš„å·¥ä½œåŸç†
2. æŸ¥çœ‹ `UniswapV3PoolDeployer.sol` äº†è§£éƒ¨ç½²æœºåˆ¶

### 2. UniswapV3Pool.sol

**èŒè´£**ï¼šå®ç°æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼ˆäº¤æ¢ã€æ·»åŠ /ç§»é™¤æµåŠ¨æ€§ã€é¢„è¨€æœºç­‰ï¼‰

**æ ¸å¿ƒçŠ¶æ€å˜é‡**ï¼š

```solidity
struct Slot0 {
    uint160 sqrtPriceX96;        // å½“å‰ä»·æ ¼ï¼ˆå¹³æ–¹æ ¹å½¢å¼ï¼‰
    int24 tick;                  // å½“å‰ Tick
    uint16 observationIndex;     // é¢„è¨€æœºè§‚å¯Ÿç´¢å¼•
    uint16 observationCardinality; // é¢„è¨€æœºå®¹é‡
    uint8 feeProtocol;           // åè®®æ‰‹ç»­è´¹æ¯”ä¾‹
    bool unlocked;               // é‡å…¥é”
}

uint128 liquidity;               // å½“å‰æ¿€æ´»çš„æµåŠ¨æ€§
mapping(int24 => Tick.Info) ticks; // Tick ä¿¡æ¯
mapping(bytes32 => Position.Info) positions; // ä»“ä½ä¿¡æ¯
```

**æ ¸å¿ƒå‡½æ•°**ï¼š

#### initialize(uint160 sqrtPriceX96)
åˆå§‹åŒ–æ± å­ï¼Œè®¾ç½®åˆå§‹ä»·æ ¼ã€‚

#### mint(...)
æ·»åŠ æµåŠ¨æ€§åˆ°æŒ‡å®šä»·æ ¼åŒºé—´ã€‚

**æµç¨‹**ï¼š
1. è°ƒç”¨ `_modifyPosition` æ›´æ–°ä»“ä½
2. è®¡ç®—éœ€è¦æä¾›çš„ token0 å’Œ token1 æ•°é‡
3. é€šè¿‡å›è°ƒ `IUniswapV3MintCallback` æ¥æ”¶ä»£å¸
4. æ›´æ–°å…¨å±€æµåŠ¨æ€§

#### burn(...)
ç§»é™¤æµåŠ¨æ€§ã€‚

**æµç¨‹**ï¼š
1. è°ƒç”¨ `_modifyPosition` å‡å°‘ä»“ä½æµåŠ¨æ€§
2. è®¡ç®—åº”è¿”è¿˜çš„ token0 å’Œ token1 æ•°é‡
3. æ›´æ–°æ‰‹ç»­è´¹åº”å¾—æ•°é‡

#### swap(...)
æ‰§è¡Œäº¤æ¢ã€‚

**æ ¸å¿ƒé€»è¾‘**ï¼š
1. ç¡®å®šäº¤æ¢æ–¹å‘ï¼ˆzeroForOneï¼‰
2. å¾ªç¯å¤„ç†æ¯ä¸ª Tickï¼š
   - è®¡ç®—å½“å‰ Tick å†…çš„äº¤æ¢
   - å¦‚æœåˆ°è¾¾è¾¹ç•Œï¼Œè·¨è¶Š Tick
   - æ›´æ–°ä»·æ ¼å’ŒæµåŠ¨æ€§
3. é€šè¿‡å›è°ƒæ¥æ”¶è¾“å…¥ä»£å¸
4. å‘é€è¾“å‡ºä»£å¸

**ç²¾å¦™ä¹‹å¤„**ï¼š
- ä½¿ç”¨ `TickBitmap` å¿«é€Ÿæ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ‰æµåŠ¨æ€§çš„ Tick
- åœ¨å•ä¸ªäº¤æ˜“ä¸­å¯èƒ½è·¨è¶Šå¤šä¸ª Tick
- æ”¯æŒç²¾ç¡®è¾“å…¥å’Œç²¾ç¡®è¾“å‡ºä¸¤ç§æ¨¡å¼

#### collect(...)
æå–æ‰‹ç»­è´¹å’Œ/æˆ–ç§»é™¤æµåŠ¨æ€§æ—¶è¿”è¿˜çš„ä»£å¸ã€‚

### 3. NoDelegateCall.sol

**ç›®çš„**ï¼šé˜²æ­¢å§”æ‰˜è°ƒç”¨æ”»å‡»

**åŸç†**ï¼š
- åœ¨æ„é€ å‡½æ•°ä¸­ä¿å­˜ `address(this)`
- åœ¨å…³é”®å‡½æ•°ä¸­ä½¿ç”¨ `noDelegateCall` ä¿®é¥°ç¬¦æ£€æŸ¥
- å¦‚æœæ˜¯å§”æ‰˜è°ƒç”¨ï¼Œ`address(this)` ä¼šæŒ‡å‘è°ƒç”¨è€…è€Œéåˆçº¦æœ¬èº«

**ä¸ºä»€ä¹ˆéœ€è¦**ï¼š
- é˜²æ­¢æ”»å‡»è€…é€šè¿‡å§”æ‰˜è°ƒç”¨ç»•è¿‡æŸäº›æ£€æŸ¥
- ä¿æŠ¤å·¥å‚åˆçº¦çš„æ‰€æœ‰è€…æƒé™

---

## æ•°å­¦åº“ç²¾æ

### 1. TickMath.sol

**æ ¸å¿ƒå‡½æ•°**ï¼š

#### getSqrtRatioAtTick(int24 tick)
å°† Tick è½¬æ¢ä¸º sqrtPriceX96ã€‚

**å®ç°æŠ€å·§**ï¼š
- ä½¿ç”¨ä½è¿ç®—å’Œé¢„è®¡ç®—çš„é­”æ³•æ•°å­—
- é€šè¿‡äºŒåˆ†æŸ¥æ‰¾ä¼˜åŒ–è®¡ç®—
- é¿å…ä½¿ç”¨æµ®ç‚¹æ•°æˆ–å¤§æ•°è¿ç®—

#### getTickAtSqrtRatio(uint160 sqrtPriceX96)
å°† sqrtPriceX96 è½¬æ¢ä¸º Tickã€‚

**å®ç°æŠ€å·§**ï¼š
- ä½¿ç”¨å¯¹æ•°è¿‘ä¼¼
- é€šè¿‡ MSBï¼ˆæœ€é«˜æœ‰æ•ˆä½ï¼‰å¿«é€Ÿå®šä½

**å­¦ä¹ è¦ç‚¹**ï¼š
- ç†è§£å®šç‚¹æ•°è¿ç®—
- å­¦ä¹ å¦‚ä½•ä¼˜åŒ–æ•°å­¦è®¡ç®—ä»¥èŠ‚çœ gas

### 2. SqrtPriceMath.sol

**æ ¸å¿ƒæ€æƒ³**ï¼šæ‰€æœ‰ä»·æ ¼è®¡ç®—éƒ½åŸºäº sqrtPriceï¼Œé¿å…å¼€æ–¹è¿ç®—ã€‚

**å…³é”®å‡½æ•°**ï¼š

#### getNextSqrtPriceFromInput/Output
æ ¹æ®è¾“å…¥/è¾“å‡ºæ•°é‡è®¡ç®—æ–°çš„ä»·æ ¼ã€‚

**å…¬å¼**ï¼š
- å¯¹äº token0 è¾“å…¥ï¼š`newSqrtPrice = liquidity * sqrtPrice / (liquidity + amount * sqrtPrice)`
- å¯¹äº token1 è¾“å…¥ï¼š`newSqrtPrice = sqrtPrice + amount / liquidity`

#### getAmount0Delta / getAmount1Delta
æ ¹æ®ä»·æ ¼åŒºé—´å’ŒæµåŠ¨æ€§è®¡ç®—éœ€è¦çš„ä»£å¸æ•°é‡ã€‚

**å…¬å¼**ï¼š
- `amount0 = L * (sqrt(Pb) - sqrt(Pa)) / (sqrt(Pa) * sqrt(Pb))`
- `amount1 = L * (sqrt(Pb) - sqrt(Pa))`

### 3. SwapMath.sol

**æ ¸å¿ƒå‡½æ•°**ï¼š`computeSwapStep`

è®¡ç®—åœ¨å•ä¸ª Tick å†…çš„äº¤æ¢ç»“æœã€‚

**è¾“å…¥**ï¼š
- `sqrtRatioCurrentX96`ï¼šå½“å‰ä»·æ ¼
- `sqrtRatioTargetX96`ï¼šç›®æ ‡ä»·æ ¼ï¼ˆä¸‹ä¸€ä¸ª Tickï¼‰
- `liquidity`ï¼šå¯ç”¨æµåŠ¨æ€§
- `amountRemaining`ï¼šå‰©ä½™äº¤æ¢æ•°é‡ï¼ˆæ­£æ•°=ç²¾ç¡®è¾“å…¥ï¼Œè´Ÿæ•°=ç²¾ç¡®è¾“å‡ºï¼‰
- `feePips`ï¼šæ‰‹ç»­è´¹ç‡

**è¾“å‡º**ï¼š
- `sqrtRatioNextX96`ï¼šäº¤æ¢åçš„ä»·æ ¼
- `amountIn`ï¼šå®é™…è¾“å…¥æ•°é‡
- `amountOut`ï¼šå®é™…è¾“å‡ºæ•°é‡
- `feeAmount`ï¼šæ‰‹ç»­è´¹æ•°é‡

**ç²¾å¦™ä¹‹å¤„**ï¼š
- å¤„ç†ç²¾ç¡®è¾“å…¥å’Œç²¾ç¡®è¾“å‡ºä¸¤ç§æƒ…å†µ
- è€ƒè™‘æ‰‹ç»­è´¹çš„å½±å“
- å¤„ç†ä»·æ ¼åˆ°è¾¾è¾¹ç•Œçš„æƒ…å†µ

### 4. Tick.sol

ç®¡ç† Tick çš„çŠ¶æ€å’Œæ›´æ–°ã€‚

**Tick.Info ç»“æ„**ï¼š
```solidity
struct Info {
    uint128 liquidityGross;      // æ€»æµåŠ¨æ€§ï¼ˆæ‰€æœ‰ä»“ä½ï¼‰
    int128 liquidityNet;         // å‡€æµåŠ¨æ€§å˜åŒ–ï¼ˆè·¨è¶Šæ—¶ï¼‰
    uint256 feeGrowthOutside0X128; // å¤–éƒ¨æ‰‹ç»­è´¹å¢é•¿ç‡
    uint256 feeGrowthOutside1X128;
    int56 tickCumulativeOutside;  // å¤–éƒ¨ç´¯è®¡ Tick
    uint160 secondsPerLiquidityOutsideX128;
    uint32 secondsOutside;
    bool initialized;
}
```

**å…³é”®å‡½æ•°**ï¼š

#### update(...)
æ›´æ–° Tick ä¿¡æ¯ï¼ˆæ·»åŠ /ç§»é™¤æµåŠ¨æ€§æ—¶è°ƒç”¨ï¼‰ã€‚

**é€»è¾‘**ï¼š
- æ›´æ–° `liquidityGross`
- æ›´æ–° `liquidityNet`ï¼ˆæ ¹æ®æ˜¯ä¸Šè¾¹ç•Œè¿˜æ˜¯ä¸‹è¾¹ç•Œï¼‰
- å¦‚æœæ˜¯æ–°åˆå§‹åŒ–çš„ Tickï¼Œè®°å½•å½“å‰å…¨å±€çŠ¶æ€

#### cross(...)
å½“ä»·æ ¼è·¨è¶Š Tick æ—¶è°ƒç”¨ã€‚

**é€»è¾‘**ï¼š
- ç¿»è½¬ `feeGrowthOutside`ï¼ˆå› ä¸º"å¤–éƒ¨"å˜æˆäº†"å†…éƒ¨"ï¼‰
- è¿”å› `liquidityNet`ï¼Œç”¨äºæ›´æ–°å…¨å±€æµåŠ¨æ€§

### 5. Position.sol

ç®¡ç†ç”¨æˆ·ä»“ä½ã€‚

**Position.Info ç»“æ„**ï¼š
```solidity
struct Info {
    uint128 liquidity;            // ä»“ä½æµåŠ¨æ€§
    uint256 feeGrowthInside0LastX128; // ä¸Šæ¬¡æ›´æ–°æ—¶çš„å†…éƒ¨æ‰‹ç»­è´¹å¢é•¿ç‡
    uint256 feeGrowthInside1LastX128;
    uint128 tokensOwed0;          // åº”å¾—ä½†æœªæå–çš„ token0
    uint128 tokensOwed1;          // åº”å¾—ä½†æœªæå–çš„ token1
}
```

**å…³é”®å‡½æ•°**ï¼š

#### update(...)
æ›´æ–°ä»“ä½å¹¶è®¡ç®—åº”å¾—æ‰‹ç»­è´¹ã€‚

**å…¬å¼**ï¼š
```solidity
tokensOwed = (feeGrowthInside - feeGrowthInsideLast) * liquidity / 2^128
```

### 6. Oracle.sol

æä¾›æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰åŠŸèƒ½ã€‚

**Observation ç»“æ„**ï¼š
```solidity
struct Observation {
    uint32 blockTimestamp;
    int56 tickCumulative;         // ç´¯è®¡ Tick * æ—¶é—´
    uint160 secondsPerLiquidityCumulativeX128; // ç´¯è®¡æ—¶é—´/æµåŠ¨æ€§
    bool initialized;
}
```

**æ ¸å¿ƒæ€æƒ³**ï¼š
- è®°å½•å†å²è§‚å¯Ÿå€¼
- é€šè¿‡ä¸¤ä¸ªæ—¶é—´ç‚¹çš„å·®å€¼è®¡ç®— TWAP
- æ”¯æŒå¯æ‰©å±•çš„è§‚å¯Ÿæ•°ç»„ï¼ˆæœ€å¤š 65535 ä¸ªï¼‰

**å…³é”®å‡½æ•°**ï¼š

#### observe(...)
æŸ¥è¯¢æŒ‡å®šæ—¶é—´ç‚¹çš„è§‚å¯Ÿå€¼ã€‚

#### write(...)
å†™å…¥æ–°çš„è§‚å¯Ÿå€¼ï¼ˆæ¯æ¬¡ä»·æ ¼æ›´æ–°æ—¶ï¼‰ã€‚

---

## è®¾è®¡æ¨¡å¼ä¸ä¼˜åŒ–

### 1. å­˜å‚¨ä¼˜åŒ–

**Slot0 æ‰“åŒ…**ï¼š
- å°†å¤šä¸ªç›¸å…³å˜é‡æ‰“åŒ…åˆ°ä¸€ä¸ªå­˜å‚¨æ§½
- å‡å°‘ SSTORE æ“ä½œï¼ŒèŠ‚çœ gas

**TickBitmap**ï¼š
- ä½¿ç”¨ä½å›¾å¿«é€ŸæŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœ‰æµåŠ¨æ€§çš„ Tick
- é¿å…éå†æ‰€æœ‰ Tick

### 2. å›è°ƒæ¨¡å¼

V3 ä½¿ç”¨å›è°ƒæ¨¡å¼æ¥æ”¶ä»£å¸ï¼š

```solidity
// åœ¨ mint/swap ä¸­
IUniswapV3MintCallback(msg.sender).uniswapV3MintCallback(amount0, amount1, data);
```

**ä¼˜åŠ¿**ï¼š
- æ”¯æŒä»»æ„ä»£å¸ï¼ˆåŒ…æ‹¬éæ ‡å‡† ERC20ï¼‰
- å…è®¸ç”¨æˆ·åœ¨å›è°ƒä¸­æ‰§è¡Œé¢å¤–é€»è¾‘
- å‡å°‘ gas æ¶ˆè€—ï¼ˆä¸éœ€è¦ approveï¼‰

### 3. é‡å…¥ä¿æŠ¤

ä½¿ç”¨ç®€å•çš„é”æœºåˆ¶ï¼š

```solidity
modifier lock() {
    require(slot0.unlocked, 'LOK');
    slot0.unlocked = false;
    _;
    slot0.unlocked = true;
}
```

### 4. ç²¾åº¦å¤„ç†

- ä½¿ç”¨å®šç‚¹æ•°é¿å…æµ®ç‚¹æ•°
- ä½¿ç”¨ `FullMath.mulDiv` è¿›è¡Œé«˜ç²¾åº¦è®¡ç®—
- æ³¨æ„èˆå…¥æ–¹å‘ï¼ˆå‘ä¸Š/å‘ä¸‹ï¼‰çš„é€‰æ‹©

### 5. Gas ä¼˜åŒ–æŠ€å·§

1. **SLOAD ä¼˜åŒ–**ï¼šå°†é¢‘ç¹è¯»å–çš„å­˜å‚¨å˜é‡ç¼“å­˜åˆ°å†…å­˜
2. **ä½è¿ç®—**ï¼šä½¿ç”¨ä½è¿ç®—æ›¿ä»£é™¤æ³•å’Œå–æ¨¡
3. **çŸ­è·¯è¯„ä¼°**ï¼šåœ¨æ¡ä»¶åˆ¤æ–­ä¸­ä¼˜å…ˆæ£€æŸ¥æœ€å¯èƒ½å¤±è´¥çš„æ¡ä»¶
4. **æ‰“åŒ…å˜é‡**ï¼šå°†å¤šä¸ªå°å˜é‡æ‰“åŒ…åˆ°ä¸€ä¸ªå­˜å‚¨æ§½

---

## å­¦ä¹ è·¯å¾„å»ºè®®

### é˜¶æ®µä¸€ï¼šåŸºç¡€ç†è§£ï¼ˆ1-2 å¤©ï¼‰

1. **é˜…è¯»æ ¸å¿ƒæ¦‚å¿µ**
   - ç†è§£ Tickã€ä»·æ ¼ã€æµåŠ¨æ€§çš„å…³ç³»
   - ç†è§£é›†ä¸­æµåŠ¨æ€§çš„æ¦‚å¿µ

2. **é˜…è¯»æ¥å£æ–‡ä»¶**
   - `interfaces/IUniswapV3Pool.sol`
   - `interfaces/pool/*.sol`
   - äº†è§£æ± å­çš„åŠŸèƒ½åˆ’åˆ†

3. **é˜…è¯»å·¥å‚åˆçº¦**
   - `UniswapV3Factory.sol`
   - `UniswapV3PoolDeployer.sol`
   - ç†è§£æ± å­çš„åˆ›å»ºè¿‡ç¨‹

### é˜¶æ®µäºŒï¼šæ•°å­¦åº“æ·±å…¥ï¼ˆ2-3 å¤©ï¼‰

1. **TickMath.sol**
   - ç†è§£ä»·æ ¼ä¸ Tick çš„è½¬æ¢
   - ç ”ç©¶ä½è¿ç®—ä¼˜åŒ–æŠ€å·§

2. **SqrtPriceMath.sol**
   - ç†è§£åŸºäº sqrtPrice çš„è®¡ç®—
   - å­¦ä¹ æµåŠ¨æ€§å…¬å¼

3. **SwapMath.sol**
   - ç†è§£å• Tick å†…çš„äº¤æ¢è®¡ç®—
   - ç†è§£ç²¾ç¡®è¾“å…¥/è¾“å‡ºçš„å¤„ç†

### é˜¶æ®µä¸‰ï¼šæ ¸å¿ƒé€»è¾‘ï¼ˆ3-5 å¤©ï¼‰

1. **æµåŠ¨æ€§ç®¡ç†**
   - é˜…è¯» `mint` å‡½æ•°
   - é˜…è¯» `burn` å‡½æ•°
   - ç†è§£ `_modifyPosition` çš„å®ç°
   - ç ”ç©¶ `Tick.sol` å’Œ `Position.sol`

2. **äº¤æ¢é€»è¾‘**
   - é˜…è¯» `swap` å‡½æ•°
   - ç†è§£ Tick è·¨è¶Šæœºåˆ¶
   - ç ”ç©¶ `TickBitmap.sol` çš„ä¼˜åŒ–

3. **æ‰‹ç»­è´¹è®¡ç®—**
   - ç†è§£å…¨å±€æ‰‹ç»­è´¹å¢é•¿ç‡
   - ç†è§£ä»“ä½æ‰‹ç»­è´¹è®¡ç®—
   - é˜…è¯» `collect` å‡½æ•°

### é˜¶æ®µå››ï¼šé«˜çº§ç‰¹æ€§ï¼ˆ2-3 å¤©ï¼‰

1. **é¢„è¨€æœº**
   - é˜…è¯» `Oracle.sol`
   - ç†è§£ TWAP è®¡ç®—
   - ç†è§£è§‚å¯Ÿæ•°ç»„çš„ç®¡ç†

2. **Flash Swap**
   - é˜…è¯» `flash` å‡½æ•°
   - ç†è§£é—ªç”µè´·æœºåˆ¶

3. **å®‰å…¨æœºåˆ¶**
   - ç†è§£ `NoDelegateCall.sol`
   - ç†è§£é‡å…¥ä¿æŠ¤
   - ç ”ç©¶è¾¹ç•Œæ¡ä»¶å¤„ç†

### é˜¶æ®µäº”ï¼šå®æˆ˜ä¸ä¼˜åŒ–ï¼ˆæŒç»­ï¼‰

1. **é˜…è¯»æµ‹è¯•æ–‡ä»¶**
   - `test/*.sol`
   - ç†è§£å„ç§è¾¹ç•Œæƒ…å†µ

2. **åˆ†æ Gas ä¼˜åŒ–**
   - ç ”ç©¶å­˜å‚¨å¸ƒå±€
   - ç ”ç©¶è®¡ç®—ä¼˜åŒ–

3. **æ‰©å±•å­¦ä¹ **
   - ç ”ç©¶ V3 Peripheryï¼ˆå¤–å›´åˆçº¦ï¼‰
   - ç ”ç©¶å…¶ä»–åŸºäº V3 çš„é¡¹ç›®

---

## å…³é”®ä»£ç ç‰‡æ®µè§£æ

### 1. ä»·æ ¼åˆå§‹åŒ–

```solidity
function initialize(uint160 sqrtPriceX96) external override {
    require(slot0.sqrtPriceX96 == 0, 'AI');
    
    int24 tick = TickMath.getTickAtSqrtRatio(sqrtPriceX96);
    
    (uint16 cardinality, uint16 cardinalityNext) = observations.initialize(_blockTimestamp());
    
    slot0 = Slot0({
        sqrtPriceX96: sqrtPriceX96,
        tick: tick,
        observationIndex: 0,
        observationCardinality: cardinality,
        observationCardinalityNext: cardinalityNext,
        feeProtocol: 0,
        unlocked: true
    });
}
```

**è¦ç‚¹**ï¼š
- åªèƒ½åˆå§‹åŒ–ä¸€æ¬¡
- åŒæ—¶åˆå§‹åŒ–ä»·æ ¼å’Œé¢„è¨€æœº
- è®¡ç®—å¯¹åº”çš„ Tick

### 2. æµåŠ¨æ€§æ·»åŠ 

```solidity
function mint(...) external returns (uint256 amount0, uint256 amount1) {
    // æ›´æ–°ä»“ä½
    (Position.Info storage position, int256 amount0Int, int256 amount1Int) =
        _modifyPosition(ModifyPositionParams({
            owner: recipient,
            tickLower: tickLower,
            tickUpper: tickUpper,
            liquidityDelta: int256(amount).toInt128()
        }));
    
    amount0 = uint256(amount0Int);
    amount1 = uint256(amount1Int);
    
    // é€šè¿‡å›è°ƒæ¥æ”¶ä»£å¸
    if (amount0 > 0) IUniswapV3MintCallback(msg.sender).uniswapV3MintCallback(amount0, amount1, data);
    
    // æ›´æ–°å…¨å±€æµåŠ¨æ€§
    if (amount0 > 0 || amount1 > 0) {
        (uint160 _sqrtPriceX96, , , , , , ) = slot0;
        (slot0.sqrtPriceX96, slot0.tick) = SwapMath.computeSwapStep(...);
    }
}
```

### 3. äº¤æ¢æ ¸å¿ƒå¾ªç¯

```solidity
while (amountRemaining != 0 && sqrtPriceX96 != sqrtPriceLimitX96) {
    // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ‰æµåŠ¨æ€§çš„ Tick
    (int24 tickNext, bool initialized) = tickBitmap.nextInitializedTickWithinOneWord(
        tick,
        tickSpacing,
        zeroForOne
    );
    
    // è®¡ç®—åœ¨è¿™ä¸ª Tick å†…çš„äº¤æ¢
    (uint160 sqrtPriceNextX96, uint256 amountIn, uint256 amountOut, uint256 feeAmount) =
        SwapMath.computeSwapStep(
            sqrtPriceX96,
            (tickNext < tick) ? TickMath.getSqrtRatioAtTick(tickNext) : sqrtPriceLimitX96,
            liquidity,
            amountRemaining,
            fee
        );
    
    // æ›´æ–°çŠ¶æ€
    sqrtPriceX96 = sqrtPriceNextX96;
    amountRemaining -= (amountIn + feeAmount).toInt256();
    amountCalculated = amountCalculated - amountOut.toInt256();
    
    // å¦‚æœåˆ°è¾¾è¾¹ç•Œï¼Œè·¨è¶Š Tick
    if (sqrtPriceX96 == TickMath.getSqrtRatioAtTick(tickNext)) {
        tick = zeroForOne ? tickNext - tickSpacing : tickNext;
        int128 liquidityNet = ticks.cross(tickNext, ...);
        liquidity = zeroForOne ? liquidity - liquidityNet : liquidity + liquidityNet;
    }
}
```

---

## å¸¸è§é—®é¢˜è§£ç­”

### Q1: ä¸ºä»€ä¹ˆä½¿ç”¨ sqrtPrice è€Œä¸æ˜¯ç›´æ¥å­˜å‚¨ priceï¼Ÿ

**A**: 
1. ç®€åŒ–æµåŠ¨æ€§è®¡ç®—ï¼š`L = amount0 * sqrt(Pa * Pb) / (sqrt(Pb) - sqrt(Pa))`
2. é¿å…å¼€æ–¹è¿ç®—ï¼šåœ¨äº¤æ¢è®¡ç®—ä¸­éœ€è¦é¢‘ç¹è®¡ç®—ä»·æ ¼å˜åŒ–
3. ç²¾åº¦è€ƒè™‘ï¼šå®šç‚¹æ•°è¿ç®—æ›´ç²¾ç¡®

### Q2: Tick é—´è·çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ

**A**:
1. **Gas ä¼˜åŒ–**ï¼šå‡å°‘éœ€è¦å­˜å‚¨å’Œæ›´æ–°çš„ Tick æ•°é‡
2. **ä»·æ ¼ç²¾åº¦æ§åˆ¶**ï¼šä¸åŒæ‰‹ç»­è´¹ç­‰çº§å¯¹åº”ä¸åŒçš„ä»·æ ¼ç²¾åº¦éœ€æ±‚
3. **é˜²æ­¢æº¢å‡º**ï¼šé™åˆ¶å•ä¸ª Tick çš„æœ€å¤§æµåŠ¨æ€§

### Q3: æ‰‹ç»­è´¹æ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Ÿ

**A**:
1. æ¯æ¬¡äº¤æ¢æ—¶ï¼Œæ‰‹ç»­è´¹æŒ‰æ¯”ä¾‹åŠ å…¥å…¨å±€æ‰‹ç»­è´¹å¢é•¿ç‡
2. æ¯ä¸ªä»“ä½è®°å½•ä¸Šæ¬¡æ›´æ–°æ—¶çš„å†…éƒ¨æ‰‹ç»­è´¹å¢é•¿ç‡
3. æå–æ—¶è®¡ç®—å·®å€¼ï¼š`(å½“å‰å¢é•¿ç‡ - ä¸Šæ¬¡å¢é•¿ç‡) * æµåŠ¨æ€§ / 2^128`

### Q4: ä¸ºä»€ä¹ˆéœ€è¦ TickBitmapï¼Ÿ

**A**:
- åœ¨äº¤æ¢æ—¶éœ€è¦å¿«é€Ÿæ‰¾åˆ°ä¸‹ä¸€ä¸ªæœ‰æµåŠ¨æ€§çš„ Tick
- å¦‚æœéå†æ‰€æœ‰ Tickï¼Œgas æ¶ˆè€—ä¼šéå¸¸å¤§
- ä½¿ç”¨ä½å›¾å¯ä»¥åœ¨ O(1) æˆ– O(log n) æ—¶é—´å†…æ‰¾åˆ°

### Q5: é¢„è¨€æœºæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

**A**:
1. æ¯æ¬¡ä»·æ ¼æ›´æ–°æ—¶ï¼Œè®°å½•è§‚å¯Ÿå€¼ï¼ˆObservationï¼‰
2. è§‚å¯Ÿå€¼åŒ…å«ï¼šæ—¶é—´æˆ³ã€ç´¯è®¡ Tickã€ç´¯è®¡æ—¶é—´/æµåŠ¨æ€§
3. æŸ¥è¯¢æ—¶ï¼Œé€šè¿‡ä¸¤ä¸ªæ—¶é—´ç‚¹çš„å·®å€¼è®¡ç®— TWAPï¼š
   - `TWAP = (tickCumulative2 - tickCumulative1) / (time2 - time1)`

---

## å»¶ä¼¸é˜…è¯»

1. **å®˜æ–¹æ–‡æ¡£**
   - [Uniswap V3 ç™½çš®ä¹¦](https://uniswap.org/whitepaper-v3.pdf)
   - [Uniswap V3 æ–‡æ¡£](https://docs.uniswap.org/)

2. **ä»£ç ä»“åº“**
   - [Uniswap V3 Core](https://github.com/Uniswap/v3-core)
   - [Uniswap V3 Periphery](https://github.com/Uniswap/v3-periphery)

3. **æŠ€æœ¯æ–‡ç« **
   - [Understanding Uniswap V3](https://www.paradigm.xyz/2021/06/understanding-uniswap-v3)
   - [Uniswap V3 æŠ€æœ¯è§£æ](https://learnblockchain.cn/article/2357)

---

## æ€»ç»“

Uniswap V3 æ˜¯ä¸€ä¸ªè®¾è®¡ç²¾å¦™çš„ DeFi åè®®ï¼Œå…¶æ ¸å¿ƒåˆ›æ–°åŒ…æ‹¬ï¼š

1. **é›†ä¸­æµåŠ¨æ€§**ï¼šå¤§å¹…æé«˜èµ„æœ¬æ•ˆç‡
2. **Tick ç³»ç»Ÿ**ï¼šç¦»æ•£åŒ–ä»·æ ¼ç©ºé—´ï¼Œä¼˜åŒ–å­˜å‚¨å’Œè®¡ç®—
3. **æ•°å­¦ä¼˜åŒ–**ï¼šä½¿ç”¨ sqrtPrice å’Œå®šç‚¹æ•°ï¼Œç®€åŒ–è®¡ç®—
4. **Gas ä¼˜åŒ–**ï¼šé€šè¿‡å¤šç§æŠ€å·§å‡å°‘ gas æ¶ˆè€—
5. **å¼ºå¤§çš„é¢„è¨€æœº**ï¼šæä¾›å¯é çš„ TWAP ä»·æ ¼æ•°æ®

é€šè¿‡ç³»ç»Ÿå­¦ä¹ è¿™ä¸ªé¡¹ç›®ï¼Œä½ å°†æ·±å…¥ç†è§£ï¼š
- å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€çš„è®¾è®¡åŸç†
- æ™ºèƒ½åˆçº¦çš„ä¼˜åŒ–æŠ€å·§
- å¤æ‚æ•°å­¦è®¡ç®—çš„å®ç°
- å®‰å…¨ç¼–ç¨‹çš„æœ€ä½³å®è·µ

ç¥ä½ å­¦ä¹ æ„‰å¿«ï¼ğŸš€

